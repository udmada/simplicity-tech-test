# Do not modify!
# This file was generated from a template using https://github.com/StefMa/pkl-gha

name: Version & Tag
'on':
  workflow_dispatch:
    inputs:
      version:
        description: Version bump type
        required: true
        default: patch
        type: choice
        options:
        - patch
        - minor
        - major
jobs:
  version:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    environment: publish-and-release
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: '0'
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Install mise
      uses: jdx/mise-action@v2
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Bump version
      run: |-
        npm version --no-git-tag-version ${{ github.event.inputs.version }}
        pnpm -r exec npm version --no-git-tag-version ${{ github.event.inputs.version }}
    - name: Get new version
      id: version
      run: |-
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "new_version=v$NEW_VERSION" >> $GITHUB_OUTPUT
    - name: Clean install artifacts
      run: git clean -fdX
    - name: Commit and push version bump
      uses: iarekylew00t/verified-bot-commit@v2
      with:
        message: 'chore: bump version to ${{ steps.version.outputs.new_version }} [skip ci]'
        files: |-
          package.json
          pnpm-lock.yaml
          packages/*/package.json
          apps/*/package.json
    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: gh release create ${{ steps.version.outputs.new_version }} --title "${{ steps.version.outputs.new_version }}" --notes "Version bump to ${{ steps.version.outputs.new_version }}" --latest
    - name: Update latest tag
      run: |-
        git tag -f latest
        git push origin latest --force
