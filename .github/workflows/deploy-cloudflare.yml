# Do not modify!
# This file was generated from a template using https://github.com/StefMa/pkl-gha

name: Deploy to Cloudflare
'on':
  pull_request:
    paths:
    - apps/web/**
    - packages/**
  push:
    branches:
    - master
    paths:
    - apps/web/**
    - packages/**
env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Install mise
      uses: jdx/mise-action@v2
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Build packages
      run: pnpm build
    - name: Build web app
      run: pnpm --filter web build
    - name: Deploy Cloudflare Worker (Preview)
      if: github.event_name == 'pull_request'
      run: |-
        cd apps/web
        wrangler deploy --preview --commit-dirty=true
    - name: Deploy Cloudflare Worker (Production)
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      run: |-
        cd apps/web
        wrangler deploy --commit-dirty=true
