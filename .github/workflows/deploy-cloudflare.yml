# Do not modify!
# This file was generated from a template using https://github.com/StefMa/pkl-gha

name: Deploy to Cloudflare
'on':
  pull_request:
    paths:
    - apps/web/**
    - packages/**
  push:
    branches:
    - master
    paths:
    - apps/web/**
    - packages/**
env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Install mise
      uses: jdx/mise-action@v2
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    - name: Build packages
      run: pnpm build
    - name: Build web app
      run: pnpm --filter web build
    - name: Deploy to Cloudflare Pages (Preview)
      if: github.event_name == 'pull_request'
      run: |-
        cd apps/web
        # Copy server bundle for _worker.js to import
        cp -r build/server build/client/
        # Deploy (includes _worker.js, server, and static assets)
        wrangler pages deploy --commit-dirty=true --branch=${{ github.head_ref }}
    - name: Deploy to Cloudflare Pages (Production)
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      run: |-
        cd apps/web
        # Copy server bundle for _worker.js to import
        cp -r build/server build/client/
        # Deploy (includes _worker.js, server, and static assets)
        wrangler pages deploy --commit-dirty=true --branch=master
    - name: Comment PR with preview URL
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |-
          const branch = context.payload.pull_request.head.ref;
          const url = `https://${branch}.simplicity-tech-test.pages.dev`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `### ðŸš€ Cloudflare Pages Preview

          Deployed to: ${url}`
          });
