amends "package://pkg.pkl-lang.org/github.com/stefma/pkl-gha/com.github.action@0.0.5#/Workflow.pkl"

import "package://pkg.pkl-lang.org/github.com/stefma/pkl-gha/com.github.action@0.0.5#/Context.pkl"

name = "Publish to npm"

on {
  workflow_dispatch {}
  workflow_run {
    workflows { "Version & Tag" }
    types { "completed" }
  }
}

jobs {
  ["publish"] {
    environment = "publish-and-release"
    permissions {
      contents = "read"
      `id-token` = "write"
    }
    `runs-on` = new UbuntuLatest {}
    `if` = "${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}"
    steps {
      new {
        name = "Checkout code"
        uses = "actions/checkout@v4"
      }
      new {
        name = "Install mise"
        uses = "jdx/mise-action@v2"
      }
      new {
        name = "Install dependencies"
        run = "pnpm install --frozen-lockfile"
      }
      new {
        name = "Run tests"
        run = "pnpm test"
      }
      new {
        name = "Build packages"
        run = "pnpm build"
      }
      new {
        name = "Publish packages"
        run = "pnpm -r publish --access public --no-git-checks"
      }
    }
  }
}
