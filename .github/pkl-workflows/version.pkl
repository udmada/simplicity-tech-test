amends "package://pkg.pkl-lang.org/github.com/stefma/pkl-gha/com.github.action@0.0.5#/Workflow.pkl"

name = "Version & Tag"

on {
  workflow_dispatch {
    inputs {
      ["version"] {
        description = "Version bump type"
        required = true
        `type` = "choice"
        options {
          "patch"
          "minor"
          "major"
        }
        `default` = "patch"
      }
    }
  }
}

jobs {
  ["version"] {
    environment = "publish-and-release"
    `runs-on` = new UbuntuLatest {}
    permissions {
      contents = "write"
    }
    steps {
      new {
        name = "Checkout code"
        uses = "actions/checkout@v4"
        with {
          ["fetch-depth"] = "0"
          ["token"] = "${{ secrets.GITHUB_TOKEN }}"
        }
      }
      new {
        name = "Install mise"
        uses = "jdx/mise-action@v2"
      }
      new {
        name = "Install dependencies"
        run = "pnpm install --frozen-lockfile"
      }
      new {
        name = "Bump version"
        run = "pnpm -rc npm version --no-git-tag-version ${{ github.event.inputs.version }}"
      }
      new {
        name = "Get new version"
        id = "version"
        run = """
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=v$NEW_VERSION" >> $GITHUB_OUTPUT
          """
      }
      new {
        name = "Clean install artifacts"
        run = "git clean -fdX"
      }
      new {
        name = "Commit and push version bump"
        uses = "iarekylew00t/verified-bot-commit@v2"
        with {
          ["message"] = "chore: bump version to ${{ steps.version.outputs.new_version }} [skip ci]"
          ["files"] = """
          package.json
          pnpm-lock.yaml
          packages/*/package.json
          apps/*/package.json
          """
        }
      }
      new {
        name = "Create GitHub Release"
        run = "gh release create ${{ steps.version.outputs.new_version }} --title \"${{ steps.version.outputs.new_version }}\" --notes \"Version bump to ${{ steps.version.outputs.new_version }}\" --latest"
        env = new {
          ["GH_TOKEN"] = "${{ secrets.GITHUB_TOKEN }}"
        }
      }
      new {
        name = "Update latest tag"
        run = """
          git tag -f latest
          git push origin latest --force
          """
      }
    }
  }
}
