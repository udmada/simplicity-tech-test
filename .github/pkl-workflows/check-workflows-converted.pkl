amends "package://pkg.pkl-lang.org/github.com/stefma/pkl-gha/com.github.action@0.0.5#/Workflow.pkl"

name = "Check Pkl Workflows Converted"

on {
  pull_request {
    paths {
      ".github/pkl-workflows/**"
      ".github/workflows/**"
    }
  }
  push {
    branches { "master" }
    paths {
      ".github/pkl-workflows/**"
      ".github/workflows/**"
    }
  }
}

jobs {
  ["check-converted"] {
    `runs-on` = new UbuntuLatest {}
    steps {
      new {
        name = "Checkout code"
        uses = "actions/checkout@v4"
      }
      new {
        name = "Install mise"
        uses = "jdx/mise-action@v2"
      }
      new {
        name = "Convert pkl workflows to yaml"
        run = """
          pkl eval .github/pkl-workflows/*.pkl -o ".github/workflows/%{moduleName}.yml"
          """
      }
      new {
        name = "Verify all pkl workflows are converted"
        run = """
          if ! git diff --exit-code .github/workflows/; then
            echo "❌ Error: Pkl workflows are not converted to YAML!"
            echo ""
            echo "Please run the following command and commit the changes:"
            echo '  pkl eval .github/pkl-workflows/*.pkl -o ".github/workflows/%{moduleName}.yml"'
            echo ""
            echo "This will convert all .pkl files to their corresponding .yml files."
            exit 1
          fi
          echo "✅ All pkl workflows are properly converted to YAML"
          """
      }
    }
  }
}
